<!DOCTYPE html>
<html>
<head>
    <title>Processing Status</title>
    <link rel="stylesheet" type="text/css" href="/static/styles.css">
    <style>
        .editable-input {
            width: 100%;
            box-sizing: border-box;
        }
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f2f2f2;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .status-pending {
            background-color: #fff3cd;
        }
        .status-approved {
            background-color: #d4edda !important;
        }
        .low-confidence {
            border-left: 5px solid #dc3545;
        }
        .progress-bar-container {
            margin-bottom: 20px;
            background-color: #e9ecef;
            border-radius: 5px;
            height: 25px;
            position: relative;
        }
        .progress-bar-fill {
            background-color: #28a745;
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            color: #333;
        }
        .batch-actions {
            margin-bottom: 10px;
        }
        .confidence-badge {
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        .confidence-high { background-color: #28a745; color: white; }
        .confidence-medium { background-color: #ffc107; color: black; }
        .confidence-low { background-color: #dc3545; color: white; }
    </style>
    <script>
        let allPurchases = [];
        const CONFIDENCE_THRESHOLD_LOW = 0.7;

        function sortTable(columnIndex) {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.querySelector("table");
            switching = true;
            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[columnIndex];
                    y = rows[i + 1].getElementsByTagName("TD")[columnIndex];
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }

        function filterByConfidence() {
            const threshold = parseFloat(document.getElementById('confidence-threshold').value);
            document.getElementById('threshold-value').textContent = threshold.toFixed(2);
            const rows = document.querySelectorAll('#results-tbody tr');
            rows.forEach(row => {
                const confidence = parseFloat(row.getAttribute('data-confidence'));
                if (isNaN(confidence) || confidence >= threshold) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function editRow(index) {
            const row = document.querySelector(`#row-${index}`);
            row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
            row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
        }

        function cancelEdit(index) {
            const row = document.querySelector(`#row-${index}`);
            row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'block');
            row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');

            // Reset input values to match view-mode text
            row.querySelector('.edit-vendor').value = row.querySelector('.view-vendor').textContent;
            row.querySelector('.edit-currency').value = row.querySelector('.view-currency').textContent;
            row.querySelector('.edit-amount').value = row.querySelector('.view-amount').textContent;
            row.querySelector('.edit-date').value = row.querySelector('.view-date').textContent;
            row.querySelector('.edit-tid').value = row.querySelector('.view-tid').textContent;
            row.querySelector('.edit-cc').value = row.querySelector('.view-cc').textContent;
            row.querySelector('.edit-ca').value = row.querySelector('.view-ca').textContent;
            row.querySelector('.edit-fa').value = row.querySelector('.view-fa').textContent;
            row.querySelector('.edit-fc').value = row.querySelector('.view-fc').textContent;
            row.querySelector('.edit-aid').value = row.querySelector('.view-aid').textContent;
        }

        async function saveRow(index, taskId) {
            const row = document.querySelector(`#row-${index}`);
            const updatedRecord = {
                vendor: row.querySelector('.edit-vendor').value,
                currency: row.querySelector('.edit-currency').value,
                amount: row.querySelector('.edit-amount').value,
                purchase_date: row.querySelector('.edit-date').value,
                transaction_id: row.querySelector('.edit-tid').value,
                crypto_currency: row.querySelector('.edit-cc').value,
                crypto_amount: row.querySelector('.edit-ca').value,
                fee_amount: row.querySelector('.edit-fa').value,
                fee_currency: row.querySelector('.edit-fc').value,
                asset_id: row.querySelector('.edit-aid').value
            };

            const response = await fetch(`/api/task/${taskId}/records/${index}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedRecord)
            });

            if (response.ok) {
                const data = await response.json();
                const record = data.updated_record;
                allPurchases[index] = record;
                updateRowUI(index, record);
                cancelEdit(index);
                updateProgress();
            } else {
                alert('Failed to save changes');
            }
        }

        async function approveRow(index, taskId) {
            const response = await fetch(`/api/task/${taskId}/records/${index}/approve`, {
                method: 'PUT'
            });

            if (response.ok) {
                const data = await response.json();
                const record = data.record;
                allPurchases[index] = record;
                updateRowUI(index, record);
                updateProgress();
            } else {
                alert('Failed to approve');
            }
        }

        async function addRecord(taskId) {
            const response = await fetch(`/api/task/${taskId}/records`, {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                allPurchases.push(data.record);
                renderTable();
                updateProgress();
            } else {
                alert('Failed to add record');
            }
        }

        async function deleteRow(index, taskId) {
            if (!confirm('Are you sure you want to delete this record?')) return;

            const response = await fetch(`/api/task/${taskId}/records/${index}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                allPurchases.splice(index, 1);
                renderTable();
                updateProgress();
            } else {
                alert('Failed to delete record');
            }
        }

        async function approveSelected(taskId) {
            const selectedIndices = [];
            document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
                selectedIndices.push(parseInt(cb.getAttribute('data-index')));
            });

            if (selectedIndices.length === 0) return;

            const response = await fetch(`/api/task/${taskId}/approve-batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(selectedIndices)
            });

            if (response.ok) {
                const data = await response.json();
                data.approved_indices.forEach(index => {
                    allPurchases[index].review_status = 'approved';
                    updateRowUI(index, allPurchases[index]);
                    document.querySelector(`.row-checkbox[data-index="${index}"]`).checked = false;
                });
                document.getElementById('select-all').checked = false;
                updateProgress();
            } else {
                alert('Failed to approve batch');
            }
        }

        function updateRowUI(index, record) {
            const row = document.querySelector(`#row-${index}`);
            row.className = record.review_status === 'approved' ? 'status-approved' : 'status-pending';
            if ((record.confidence_score || 0) < CONFIDENCE_THRESHOLD_LOW) {
                row.classList.add('low-confidence');
            }

            row.querySelector('.view-vendor').textContent = record.vendor || '';
            row.querySelector('.view-currency').textContent = record.currency || '';
            row.querySelector('.view-amount').textContent = record.amount || '';
            row.querySelector('.view-date').textContent = record.purchase_date || '';
            row.querySelector('.view-tid').textContent = record.transaction_id || '';
            row.querySelector('.view-cc').textContent = record.crypto_currency || '';
            row.querySelector('.view-ca').textContent = record.crypto_amount || '';
            row.querySelector('.view-fa').textContent = record.fee_amount || '';
            row.querySelector('.view-fc').textContent = record.fee_currency || '';
            row.querySelector('.view-aid').textContent = record.asset_id || '';
            row.querySelector('.view-status').textContent = record.review_status || 'pending';

            const approveBtn = row.querySelector('.approve-btn');
            if (record.review_status === 'approved') {
                approveBtn.style.display = 'none';
            } else {
                approveBtn.style.display = 'inline-block';
            }
        }

        function updateProgress() {
            const total = allPurchases.length;
            const approved = allPurchases.filter(p => p.review_status === 'approved').length;
            const percent = total > 0 ? (approved / total) * 100 : 0;

            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${approved} / ${total} Approved`;
        }

        function toggleSelectAll() {
            const checked = document.getElementById('select-all').checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            if (e.key === 'a') {
                const taskId = document.getElementById('task-id').textContent;
                approveSelected(taskId);
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div id="processing-section">
            <h1>Processing your file...</h1>
            <p>Task ID: <span id="task-id">{{ task_id }}</span></p>
            <p>Status: <span id="status">processing</span></p>
        </div>

        <div id="results-section" style="display: none;">
            <h1>Extracted Purchases</h1>

            <div class="progress-bar-container">
                <div id="progress-fill" class="progress-bar-fill" style="width: 0%"></div>
                <div id="progress-text" class="progress-text">0 / 0 Approved</div>
            </div>

            <div class="filter-section">
                <div>
                    <label for="confidence-threshold">Confidence Threshold: </label>
                    <input type="range" id="confidence-threshold" min="0" max="1" step="0.05" value="0" oninput="filterByConfidence()">
                    <span id="threshold-value">0.00</span>
                </div>

                <div class="export-buttons" style="margin-bottom: 0;">
                    <a id="export-csv" href="#" download><button>Export to CSV</button></a>
                    <a id="export-json" href="#" download><button>Export to JSON</button></a>
                    <a id="export-koinly" href="#" download><button>Export to Koinly</button></a>
                    <a id="export-ctc" href="#" download><button>Export to CTC</button></a>
                    <a id="export-cra" href="#" download><button>Export to CRA</button></a>
                    <a id="export-cra-pdf" href="#" download><button>Export to CRA PDF</button></a>
                    <a href="/"><button>Process Another File</button></a>
                </div>
            </div>

            <div class="batch-actions">
                <button onclick="approveSelected(document.getElementById('task-id').textContent)">Approve Selected (a)</button>
                <button onclick="addRecord(document.getElementById('task-id').textContent)">Add Transaction</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></th>
                        <th onclick="sortTable(1)">Email Subject</th>
                        <th onclick="sortTable(2)">Vendor</th>
                        <th onclick="sortTable(3)">Amount (Fiat)</th>
                        <th onclick="sortTable(4)">Currency</th>
                        <th onclick="sortTable(5)">Crypto Amount</th>
                        <th onclick="sortTable(6)">Crypto Currency</th>
                        <th onclick="sortTable(7)">Fee Amount</th>
                        <th onclick="sortTable(8)">Fee Currency</th>
                        <th onclick="sortTable(9)">Asset ID</th>
                        <th onclick="sortTable(10)">Date</th>
                        <th onclick="sortTable(11)">Transaction ID</th>
                        <th onclick="sortTable(12)">Confidence</th>
                        <th onclick="sortTable(13)">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const taskId = document.getElementById('task-id').textContent;
        const statusElement = document.getElementById('status');
        const processingSection = document.getElementById('processing-section');
        const resultsSection = document.getElementById('results-section');
        const resultsTbody = document.getElementById('results-tbody');
        const exportCsv = document.getElementById('export-csv');
        const exportJson = document.getElementById('export-json');
        const exportKoinly = document.getElementById('export-koinly');
        const exportCtc = document.getElementById('export-ctc');
        const exportCra = document.getElementById('export-cra');
        const exportCraPdf = document.getElementById('export-cra-pdf');

        const interval = setInterval(() => {
            fetch(`/api/status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    statusElement.textContent = data.status;
                    if (data.status === 'complete') {
                        clearInterval(interval);
                        processingSection.style.display = 'none';
                        resultsSection.style.display = 'block';
                        exportCsv.href = `/api/export/csv/${taskId}`;
                        exportJson.href = `/api/export/json/${taskId}`;
                        exportKoinly.href = `/api/export/koinly/${taskId}`;
                        exportCtc.href = `/api/export/ctc/${taskId}`;
                        exportCra.href = `/api/export/cra/${taskId}`;
                        exportCraPdf.href = `/api/export/cra-pdf/${taskId}`;

                        allPurchases = data.result || [];
                        renderTable();
                        updateProgress();
                    }
                });
        }, 2000);

        function renderTable() {
            resultsTbody.innerHTML = '';
            if (allPurchases.length === 0) {
                resultsTbody.innerHTML = '<tr><td colspan="13">No purchases found.</td></tr>';
                return;
            }

            allPurchases.forEach((purchase, index) => {
                const row = document.createElement('tr');
                row.id = `row-${index}`;
                row.setAttribute('data-confidence', purchase.confidence_score || 0);

                const confidenceClass = purchase.confidence_score >= 0.9 ? 'confidence-high' :
                                      purchase.confidence_score >= 0.7 ? 'confidence-medium' : 'confidence-low';

                row.className = purchase.review_status === 'approved' ? 'status-approved' : 'status-pending';
                if ((purchase.confidence_score || 0) < CONFIDENCE_THRESHOLD_LOW) {
                    row.classList.add('low-confidence');
                }

                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" data-index="${index}"></td>
                    <td>${purchase.email_subject || ''}</td>
                    <td>
                        <span class="view-mode view-vendor">${purchase.vendor || ''}</span>
                        <input type="text" class="edit-mode edit-vendor editable-input" value="${purchase.vendor || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-amount">${purchase.amount || ''}</span>
                        <input type="text" class="edit-mode edit-amount editable-input" value="${purchase.amount || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-currency">${purchase.currency || ''}</span>
                        <input type="text" class="edit-mode edit-currency editable-input" value="${purchase.currency || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-ca">${purchase.crypto_amount || ''}</span>
                        <input type="text" class="edit-mode edit-ca editable-input" value="${purchase.crypto_amount || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-cc">${purchase.crypto_currency || ''}</span>
                        <input type="text" class="edit-mode edit-cc editable-input" value="${purchase.crypto_currency || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-fa">${purchase.fee_amount || ''}</span>
                        <input type="text" class="edit-mode edit-fa editable-input" value="${purchase.fee_amount || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-fc">${purchase.fee_currency || ''}</span>
                        <input type="text" class="edit-mode edit-fc editable-input" value="${purchase.fee_currency || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-aid">${purchase.asset_id || ''}</span>
                        <input type="text" class="edit-mode edit-aid editable-input" value="${purchase.asset_id || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-date">${purchase.purchase_date || ''}</span>
                        <input type="text" class="edit-mode edit-date editable-input" value="${purchase.purchase_date || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="view-mode view-tid">${purchase.transaction_id || ''}</span>
                        <input type="text" class="edit-mode edit-tid editable-input" value="${purchase.transaction_id || ''}" style="display:none">
                    </td>
                    <td>
                        <span class="confidence-badge ${confidenceClass}">${(purchase.confidence_score || 0).toFixed(2)}</span>
                    </td>
                    <td><span class="view-status">${purchase.review_status || 'pending'}</span></td>
                    <td>
                        <button class="view-mode approve-btn" onclick="approveRow(${index}, '${taskId}')" style="${purchase.review_status === 'approved' ? 'display:none' : ''}">Approve</button>
                        <button class="view-mode" onclick="editRow(${index})">Edit</button>
                        <button class="view-mode" onclick="deleteRow(${index}, '${taskId}')">Delete</button>
                        <button class="edit-mode" onclick="saveRow(${index}, '${taskId}')" style="display:none">Save</button>
                        <button class="edit-mode" onclick="cancelEdit(${index})" style="display:none">Cancel</button>
                    </td>
                `;
                resultsTbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
