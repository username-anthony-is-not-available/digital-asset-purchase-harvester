<!DOCTYPE html>
<html>
<head>
    <title>Processing Status</title>
    <link rel="stylesheet" type="text/css" href="/static/styles.css">
    <style>
        .editable-input {
            width: 100%;
            box-sizing: border-box;
        }
        .filter-section {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f2f2f2;
            border-radius: 5px;
        }
    </style>
    <script>
        function sortTable(columnIndex) {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.querySelector("table");
            switching = true;
            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[columnIndex];
                    y = rows[i + 1].getElementsByTagName("TD")[columnIndex];
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }

        function filterByConfidence() {
            const threshold = parseFloat(document.getElementById('confidence-threshold').value);
            document.getElementById('threshold-value').textContent = threshold.toFixed(2);
            const rows = document.querySelectorAll('#results-tbody tr');
            rows.forEach(row => {
                const confidence = parseFloat(row.getAttribute('data-confidence'));
                if (isNaN(confidence) || confidence >= threshold) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function editRow(index) {
            const row = document.querySelector(`#row-${index}`);
            row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
            row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
        }

        function cancelEdit(index) {
            const row = document.querySelector(`#row-${index}`);
            row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'block');
            row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');

            // Reset input values to match view-mode text
            row.querySelector('.edit-vendor').value = row.querySelector('.view-vendor').textContent;
            row.querySelector('.edit-currency').value = row.querySelector('.view-currency').textContent;
            row.querySelector('.edit-amount').value = row.querySelector('.view-amount').textContent;
            row.querySelector('.edit-date').value = row.querySelector('.view-date').textContent;
            row.querySelector('.edit-tid').value = row.querySelector('.view-tid').textContent;
            row.querySelector('.edit-cc').value = row.querySelector('.view-cc').textContent;
            row.querySelector('.edit-ca').value = row.querySelector('.view-ca').textContent;
        }

        async function saveRow(index, taskId) {
            const row = document.querySelector(`#row-${index}`);
            const updatedRecord = {
                vendor: row.querySelector('.edit-vendor').value,
                currency: row.querySelector('.edit-currency').value,
                amount: row.querySelector('.edit-amount').value,
                purchase_date: row.querySelector('.edit-date').value,
                transaction_id: row.querySelector('.edit-tid').value,
                crypto_currency: row.querySelector('.edit-cc').value,
                crypto_amount: row.querySelector('.edit-ca').value
            };

            const response = await fetch(`/api/task/${taskId}/records/${index}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedRecord)
            });

            if (response.ok) {
                const data = await response.json();
                const record = data.updated_record;
                // Update view mode
                row.querySelector('.view-vendor').textContent = record.vendor || '';
                row.querySelector('.view-currency').textContent = record.currency || '';
                row.querySelector('.view-amount').textContent = record.amount || '';
                row.querySelector('.view-date').textContent = record.purchase_date || '';
                row.querySelector('.view-tid').textContent = record.transaction_id || '';
                row.querySelector('.view-cc').textContent = record.crypto_currency || '';
                row.querySelector('.view-ca').textContent = record.crypto_amount || '';

                cancelEdit(index);
            } else {
                alert('Failed to save changes');
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div id="processing-section">
            <h1>Processing your file...</h1>
            <p>Task ID: <span id="task-id">{{ task_id }}</span></p>
            <p>Status: <span id="status">processing</span></p>
        </div>

        <div id="results-section" style="display: none;">
            <h1>Extracted Purchases</h1>

            <div class="filter-section">
                <label for="confidence-threshold">Confidence Threshold: </label>
                <input type="range" id="confidence-threshold" min="0" max="1" step="0.05" value="0" oninput="filterByConfidence()">
                <span id="threshold-value">0.00</span>
            </div>

            <div class="export-buttons">
                <a id="export-csv" href="#" download>
                    <button>Export to CSV</button>
                </a>
                <a id="export-json" href="#" download>
                    <button>Export to JSON</button>
                </a>
                <a href="/">
                    <button>Process Another File</button>
                </a>
            </div>
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Email Subject</th>
                        <th onclick="sortTable(1)">Vendor</th>
                        <th onclick="sortTable(2)">Currency</th>
                        <th onclick="sortTable(3)">Amount</th>
                        <th onclick="sortTable(4)">Purchase Date</th>
                        <th onclick="sortTable(5)">Transaction ID</th>
                        <th onclick="sortTable(6)">Crypto Currency</th>
                        <th onclick="sortTable(7)">Crypto Amount</th>
                        <th onclick="sortTable(8)">Confidence Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const taskId = document.getElementById('task-id').textContent;
        const statusElement = document.getElementById('status');
        const processingSection = document.getElementById('processing-section');
        const resultsSection = document.getElementById('results-section');
        const resultsTbody = document.getElementById('results-tbody');
        const exportCsv = document.getElementById('export-csv');
        const exportJson = document.getElementById('export-json');

        const interval = setInterval(() => {
            fetch(`/api/status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    statusElement.textContent = data.status;
                    if (data.status === 'complete') {
                        clearInterval(interval);
                        processingSection.style.display = 'none';
                        resultsSection.style.display = 'block';
                        exportCsv.href = `/api/export/csv/${taskId}`;
                        exportJson.href = `/api/export/json/${taskId}`;

                        const purchases = data.result || [];
                        if (purchases.length === 0) {
                            resultsTbody.innerHTML = '<tr><td colspan="10">No purchases found.</td></tr>';
                        } else {
                            purchases.forEach((purchase, index) => {
                                const row = document.createElement('tr');
                                row.id = `row-${index}`;
                                row.setAttribute('data-confidence', purchase.confidence_score || 0);
                                row.innerHTML = `
                                    <td>${purchase.email_subject || ''}</td>
                                    <td>
                                        <span class="view-mode view-vendor">${purchase.vendor || ''}</span>
                                        <input type="text" class="edit-mode edit-vendor editable-input" value="${purchase.vendor || ''}" style="display:none">
                                    </td>
                                    <td>
                                        <span class="view-mode view-currency">${purchase.currency || ''}</span>
                                        <input type="text" class="edit-mode edit-currency editable-input" value="${purchase.currency || ''}" style="display:none">
                                    </td>
                                    <td>
                                        <span class="view-mode view-amount">${purchase.amount || ''}</span>
                                        <input type="text" class="edit-mode edit-amount editable-input" value="${purchase.amount || ''}" style="display:none">
                                    </td>
                                    <td>
                                        <span class="view-mode view-date">${purchase.purchase_date || ''}</span>
                                        <input type="text" class="edit-mode edit-date editable-input" value="${purchase.purchase_date || ''}" style="display:none">
                                    </td>
                                    <td>
                                        <span class="view-mode view-tid">${purchase.transaction_id || ''}</span>
                                        <input type="text" class="edit-mode edit-tid editable-input" value="${purchase.transaction_id || ''}" style="display:none">
                                    </td>
                                    <td>
                                        <span class="view-mode view-cc">${purchase.crypto_currency || ''}</span>
                                        <input type="text" class="edit-mode edit-cc editable-input" value="${purchase.crypto_currency || ''}" style="display:none">
                                    </td>
                                    <td>
                                        <span class="view-mode view-ca">${purchase.crypto_amount || ''}</span>
                                        <input type="text" class="edit-mode edit-ca editable-input" value="${purchase.crypto_amount || ''}" style="display:none">
                                    </td>
                                    <td>${purchase.confidence_score || ''}</td>
                                    <td>
                                        <button class="view-mode" onclick="editRow(${index})">Edit</button>
                                        <button class="edit-mode" onclick="saveRow(${index}, '${taskId}')" style="display:none">Save</button>
                                        <button class="edit-mode" onclick="cancelEdit(${index})" style="display:none">Cancel</button>
                                    </td>
                                `;
                                resultsTbody.appendChild(row);
                            });
                        }
                    }
                });
        }, 2000);
    </script>
</body>
</html>
